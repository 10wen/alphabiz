(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[9],{"2e03":function(t,e,s){},"426d":function(t,e,s){"use strict";s("2e03")},"52af":function(t,e,s){},"5bd9":function(t,e,s){},7846:function(t,e,s){"use strict";s("5bd9")},9176:function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("q-page",{staticStyle:{position:"relative"}},[s("input",{ref:"file",staticStyle:{display:"none"},attrs:{id:"media-file-upload",type:"file","data-cy":"file-input"},on:{input:t.manualAddFile}}),s("input",{ref:"subtitle",staticStyle:{display:"none"},attrs:{type:"file",accept:".srt,.vtt"},on:{input:t.manualAddSubtitle}}),s("div",{staticStyle:{position:"absolute",height:"100%",width:"100%"},attrs:{id:"video-container"}},[s("video",{ref:"video",staticClass:"video-js vjs-default-skin vjs-16-9 vjs-big-play-centered vjs-fluid",attrs:{crossorigin:"anonymous",id:"my-video"}})]),s("audio-info",{attrs:{show:t.isAudio}}),s("video-splash",{attrs:{show:t.showSplash,videoLoadingHint:t.$t("waiting_for_torrent")}}),s("advanced-options",{attrs:{show:t.showAdvancedOptions,advancedOptions:t.advancedOpt},on:{close:function(){return t.toggleAdvancedOptions(!1)}}})],1)},i=[],o=(s("5319"),s("ddb0"),s("2b3d"),s("9861"),s("f0e2")),n=s("6922"),r=s.n(n);s("fda2"),s("7f10"),s("5898");const l=s("3e8f"),d=s("df7c");function c(t){if(console.log(t.path||t),!l.existsSync(t.path||t))return[];const e=d.dirname(t.path),s=d.extname(t.path),a=t.name.substring(0,t.name.lastIndexOf("."));console.log(e,a,s);const i=h(e,a),o=p(e,i),n=y(e,a),r=u(e,n);return[...o,...r]}function u(t,e){const s=[];try{e.forEach(((e,a,i)=>{i[a]=t+"/"+e;const o=l.readFileSync(i[a],"utf-8"),n=1===(e.match(/\./g)||[]).length?e:d.extname(e.substring(0,e.lastIndexOf("."))).substring(1)+".srt";s.push({src:URL.createObjectURL(new Blob([f(o)])),label:n})}))}catch(a){console.log(a)}return console.log(s),s}function p(t,e){const s=[];try{e.forEach(((e,a,i)=>{i[a]=t+"/"+e;const o=l.readFileSync(i[a],"utf-8"),n=1===(e.match(/\./g)||[]).length?e:d.extname(e.substring(0,e.lastIndexOf("."))).substring(1)+".vtt";s.push({src:URL.createObjectURL(new Blob([o])),label:n})}))}catch(a){console.log(a)}return console.log(s),s}function h(t,e){let s;try{s=l.readdirSync(t),s=s.filter((t=>t.startsWith(e)&&t.endsWith(".vtt")))}catch(a){console.log(a)}return s}function y(t,e){let s;try{s=l.readdirSync(t),s=s.filter((t=>t.startsWith(e)&&t.endsWith(".srt")))}catch(a){console.log(a)}return s}function f(t){var e=t.replace(/\r+/g,"");e=e.replace(/^\s+|\s+$/g,"");var s=e.split("\n\n"),a="";if(s.length>0){a+="WEBVTT\n\n";for(var i=0;i<s.length;i+=1)a+=g(s[i])}return a}function g(t){var e="",s=t.split(/\n/);while(s.length>3){for(var a=3;a<s.length;a++)s[2]+="\n"+s[a];s.splice(3,s.length-3)}var i=0;if(!s[0].match(/\d+:\d+:\d+/)&&s[1].match(/\d+:\d+:\d+/)&&(e+=s[0].match(/\w+/)+"\n",i+=1),!s[i].match(/\d+:\d+:\d+/))return"";var o=s[1].match(/(\d+):(\d+):(\d+)(?:,(\d+))?\s*--?>\s*(\d+):(\d+):(\d+)(?:,(\d+))?/);return o?(e+=o[1]+":"+o[2]+":"+o[3]+"."+o[4]+" --\x3e "+o[5]+":"+o[6]+":"+o[7]+"."+o[8]+"\n",i+=1,s[i]&&(e+=s[i]+"\n\n"),e):""}const m=s("ed08").isElectron();function v(t){if(!m||"string"!==typeof t)return t;const e=s("df7c"),a=e.basename(t);return{name:a,path:t}}var b=s("307e"),w=s("4d5f"),S=s("0613"),_=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("div",{directives:[{name:"show",rawName:"v-show",value:t.show,expression:"show"}],attrs:{id:"video-splash"}},[s("div",{staticClass:"loading"},[s("q-circular-progress",{staticClass:"q-ma-md",attrs:{indeterminate:"",size:"24px",color:"primary"}}),s("p",[t._v(t._s(t.videoLoadingHint))])],1)])])},x=[],P={name:"VideoSplash",props:{show:{type:Boolean},videoLoadingHint:{type:String}},data(){return{}},created(){},mounted(){},computed:{},methods:{}},C=P,O=(s("426d"),s("2877")),$=s("58ea"),V=s("eebe"),A=s.n(V),k=Object(O["a"])(C,_,x,!1,null,"077eff30",null),B=k.exports;A()(k,"components",{QCircularProgress:$["a"]});var j=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("div",{directives:[{name:"show",rawName:"v-show",value:t.show,expression:"show"}],staticClass:"audio-info-container"},[s("p",{staticClass:"info"},[t._v(t._s(t.$t("this_is_an_audio_file")))]),s("img",{attrs:{src:"favicon.ico",alt:"favicon",width:"100px"}})])])},T=[],q={name:"AudioInfo",components:{},props:{show:{type:Boolean}},data(){return{}},created(){},mounted(){},computed:{},methods:{}},L=q,R=(s("7846"),Object(O["a"])(L,j,T,!1,null,"abfb3674",null)),U=R.exports,I=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("q-dialog",{attrs:{value:t.show},on:{input:t.close}},[s("q-card",{staticStyle:{width:"600px","max-width":"80vw","overflow-x":"hidden"}},[s("q-card-section",{staticClass:"row"},[s("div",{staticClass:"text-h6 col-12"},[t._v(t._s(t.$t("advanced_options")))])]),s("q-card-section",{staticClass:"row"},[s("div",{staticClass:"col-4 justify-start q-pl-xl q-my-md"},[t._v(t._s(t.advancedOptions[0].name)+":")]),s("div",{staticClass:"col-8 justify-start q-pl-md q-my-md",staticStyle:{"word-wrap":"break-word"}},[t._v(t._s(t.advancedOptions[0].value))]),s("div",{staticClass:"col-4 justify-start q-pl-xl q-my-md"},[t._v(t._s(t.advancedOptions[1].name)+":")]),s("div",{staticClass:"col-8 justify-start q-pl-md q-my-md",staticStyle:{"word-wrap":"break-word"}},[t._v(t._s(t.advancedOptions[1].value))]),s("div",{staticClass:"col-4 justify-start q-pl-xl q-my-md"},[t._v(t._s(t.advancedOptions[2].name)+":")]),s("div",{staticClass:"col-8 justify-start q-pl-md q-my-md",staticStyle:{"word-wrap":"break-word"}},t._l(t.advancedOptions[2].value,(function(e,a){return s("div",{key:a,staticClass:"license-section"},[t._v("\n          "+t._s(e)+"\n        ")])})),0)])],1)],1)},F=[],H={name:"AdvancedOptions",components:{},props:{show:Boolean,advancedOptions:Array},data(){return{}},created(){},mounted(){},computed:{},methods:{close(){this.$emit("close")}}},E=H,W=s("24e8"),M=s("f09f"),N=s("a370"),Q=Object(O["a"])(E,I,F,!1,null,"e9245f3a",null),z=Q.exports;A()(Q,"components",{QDialog:W["a"],QCard:M["a"],QCardSection:N["a"]});const D=s("ed08").isElectron();let J=null;D&&(J=s("bdb9").ipcRenderer),window.videojs=o["default"],s("d80d"),s("01a0"),s("8d5e");var G={name:"Player",inject:["rootApp","io"],components:{VideoSplash:B,AudioInfo:U,AdvancedOptions:z},data(){return{player:null,playerOptions:{plugins:{hotkeys:r.a},autoplay:!0,preload:"auto",controls:!0,controlBar:{volumePanel:{inline:!1}}},subsBtn:null,progress:0,fileName:"",subtitleList:[],showSplash:!1,showAdvancedOptions:!1,isAudio:!1}},created(){this.initVideoComponent(),window.addEventListener("error",(t=>{console.log("Uncaught global error",t.message,"\nThis has no effect to app and can be ignore")})),D&&("Alphabiz"===this.settings.defaultVideoPlayer&&J.send("request-ask-for-player"),J.on("ask-for-player",(()=>{this.$q.notify({message:this.$t("not_default_player"),actions:[{label:this.$t("dont_show_again"),handler:()=>{S["a"].dispatch("set",{dontAskForPlayer:!0})}},{label:this.$t("go_to_settings"),handler:()=>{this.$router.push("/basicSetting")}}]})})))},mounted(){this.loadPlayer(!0)},async activated(){D&&(S["a"].state.video.currentVideo.remotePlay&&(this.loadPlayer(!0),this.toggleSplash(!0),J.send("get-stream-address"),J.once("stream-address",((t,e)=>{this.toggleSplash(!1);const{address:s,filepath:a}=e;console.log("Stream play, try update player.src",e,s,a),S["a"].dispatch("currentVideoUrl",s),S["a"].dispatch("currentVideoPath",a);try{this.updateSrc(s),this.player.play(),S["a"].dispatch("resetRemotePlay"),this.clearOldSubtitle(),this.addSubtitle(a)}catch(t){console.log("src err",t),S["a"].dispatch("resetRemotePlay")}}))),S["a"].state.video.currentVideo.url||S["a"].state.video.currentVideo.infoHash||this.loadPlayer(!0)),this.io.on("server_progress",(t=>{if("/player"!==this.$router.currentRoute.path)return;if(!this.player.readyState())return;const e=t.find((t=>{var e;return null===(e=S["a"].state.video.currentVideo)||void 0===e?void 0:e.url.includes(t.name)}));if(e&&e.progress){const t=[],s=e.progress.length;let a=e.progress[0],i=1;for(let o=1;o<s;o++)if(e.progress[o]===a&&o<s-1)i+=1;else{if(e.progress[o+1]===a){i+=1;continue}o===s-1&&(i+=1),i&&t.push({color:1===a?"gold":"transparent",length:i/s*100+"%"}),a=e.progress[o],i=1}this.updateProgress(t)}}))},beforeDestroy(){this&&this.player&&this.player.dispose()},computed:{settings(){const t=S["a"].state.setting;return{defaultVideoPlayer:t.defaultVideoPlayer}},advancedOpt(){let t=S["a"].state.video.currentVideo.path;const e=S["a"].state.video.currentVideo.url;e.startsWith("play://")&&(t=decodeURI(e).replace("play:///","").replace(/\//g,"\\"));const s=t?t.match(/(?:.(?!\\))+$/):this.fileName;return[{name:this.$t("title"),value:decodeURIComponent(s).replace("\\","")},{name:this.$t("location"),value:t},{name:this.$t("subtitle_file"),value:this.subtitleList}]}},watch:{"$store.state.setting.language"(t,e){t&&t!==e&&this.languageChange()},"$store.state.video.currentVideo.updatePlayer"(t,e){console.log("watch updatePlayer:",t),t&&t!==e&&(console.log("need update player"),S["a"].dispatch("updatePlayer",!1),this.updatePlayer(S["a"].state.video.currentVideo.url))}},methods:{toggleSplash(t){this.showSplash=t},toggleAudio(t){this.isAudio=t},toggleAdvancedOptions(t){this.showAdvancedOptions=t},openFile(){this.$refs.file.click()},languageChange(){const t=S["a"].state.setting.language||"en-US";this.player&&this.player.language(t),console.log("lang:"+t,this.player)},manualAddFile(t){console.log("Open Media File: "+t.target.files[0].name),0!==t.target.files.length&&(t.target.files[0].path&&S["a"].dispatch("currentVideoPath",t.target.files[0].path),this.updatePlayer(t.target.files[0]),setTimeout((()=>{this.$refs.file.value=null}),500))},async manualAddSubtitle(t){const e=t.target.files;if(!e.length)return;const s=e[0];console.log("manualAddSubtitle",s,s.name);const a=this.player.textTracks();await this.addSubtitle(s,s.name);let i=-1;setTimeout((()=>{for(let t=0;t<a.length;t++)s.name.includes(a[t].label)&&(i=t),a[t].mode="disabled";-1!==i&&(a[i].mode="showing"),this.appendAddSubBtn(),t.target.value=""}),500)},initVideoComponent(){const t=o["default"].getComponent("Button"),e=o["default"].getComponent("MenuItem");o["default"].registerComponent("FileButton",o["default"].extend(t,{constructor:function(){t.apply(this,arguments);const e=arguments[1];this._text=e.text||"Open File...",this.el_.innerHTML=`<span class="open" title="${this._text}"></span>`}})),o["default"].registerComponent("SubsButton",o["default"].extend(t,{constructor:function(){t.apply(this,arguments);const e=arguments[1];this._text=e.text||"Add subtitles...",this.el_.innerHTML=`<span class="subs" title="${this._text}"></span>`}})),o["default"].registerComponent("AddSubButton",o["default"].extend(e,{constructor:function(){e.apply(this,arguments);const t=arguments[1];this._text=t.text||"Add subtitles...",this.el_.innerHTML+=`<span>${this._text}</span>`}})),o["default"].registerComponent("AdvancedOptionsButton",o["default"].extend(t,{constructor:function(){t.apply(this,arguments);const e=arguments[1];this._text=e.text||"Advanced Options",this.el_.innerHTML=`<span class="advanced" title="${this._text}"></span>`}}))},addControlBarComponent(){const t=this.player.controlBar.addChild("FileButton",{text:this.$t("open_file")},1);t.on("click",this.openFile),this.subsBtn=this.player.controlBar.addChild("SubsButton",{text:this.$t("add_subtitles")},14),this.subsBtn.on("click",(()=>this.$refs.subtitle.click()));const e=this.player.controlBar.addChild("AdvancedOptionsButton",{text:this.$t("advanced_options")},16);e.on("click",(()=>{this.toggleAdvancedOptions(!0)}))},loadPlayer(t=!1){let e=()=>{};const s=new Promise((t=>{e=t}));if(!o["default"].getPlayer("my-video")||t){if(t){console.log("force load player()"),Object(o["default"])("my-video")&&Object(o["default"])("my-video").dispose();const t=document.querySelector("#video-container");t&&(t.innerHTML='<video\n            crossorigin="anonymous"\n            id="my-video"\n            class="video-js vjs-default-skin vjs-16-9 vjs-big-play-centered vjs-fluid"\n            ref="video"\n            style="height:100%"\n          ></video>')}return this.player=Object(o["default"])("my-video",this.playerOptions,(()=>e())),this.player.on("change",(()=>{})),this.player.on("ready",(async()=>{S["a"].dispatch("updateVideoStatus",!1),this.languageChange()})),this.player.on("canplay",(()=>{const t=document.querySelector("#my-video video");t.style.backgroundColor="black";const e=(this.fileName||S["a"].state.video.currentVideo.path).split(".").pop();Object(b["b"])(e)&&this.toggleAudio(!0)})),this.player.on("play",(async()=>{if("Alphabiz"!==this.settings.defaultVideoPlayer&&S["a"].state.video.currentVideo.url.startsWith("play://")){this.player.pause(),this.player.exitPictureInPicture();const t=S["a"].state.video.currentVideo.path;console.log("player will pause,open default player,"+t),await Object(w["b"])(this.settings.defaultVideoPlayer,t),S["a"].dispatch("resetRemotePlay"),S["a"].dispatch("resetInfoHash"),S["a"].dispatch("currentVideoUrl",""),S["a"].dispatch("currentVideoPath",""),this.loadPlayer(!0)}else S["a"].dispatch("updateVideoStatus",!0)})),this.player.on("pause",(()=>{S["a"].dispatch("updateVideoStatus",!1)})),this.player.on("leavepictureinpicture",(()=>{S["a"].dispatch("updateVideoPIPStatus",!1),this.$router.push("/player")})),this.player.on("enterpictureinpicture",(()=>{S["a"].dispatch("updateVideoPIPStatus",!0),setTimeout((()=>this.player.play()),500)})),this.player.on("error",(()=>{this.toggleSplash(!1);const t=this.player.languages()[this.player.language()],e=t&&t[this.player.error_.message]||this.player.error_.message;this.$q.notify(e),S["a"].dispatch("currentVideoUrl",null),S["a"].dispatch("currentVideoPath",null),this.loadPlayer(!0)})),this.player.textTracks().on("change",(()=>{})),S["a"].state.video.currentVideo.url&&!S["a"].state.video.currentVideo.remotePlay&&(console.log("reload resources after modify code in dev mode!"),this.updateSrc(S["a"].state.video.currentVideo.url)),this.player.bigPlayButton.on("click",this.openFile),this.addControlBarComponent(),S["a"].dispatch("updateVideoPIPStatus",!1),s}this.player=o["default"].getPlayer("my-video")},async updatePlayer(t){if(!t)return;this.player||await this.loadPlayer();const e="string"===typeof t?t:URL.createObjectURL(t);console.log("updatePlayer",t,e),this.fileName=t.name,S["a"].dispatch("currentVideoUrl",e),this.updateSrc(e),S["a"].dispatch("resetInfoHash"),this.clearOldSubtitle(),await this.addSubtitle(t,t.name)},updateSrc(t){this.toggleAudio(!1),t.startsWith("play://")&&(t+=`?infoHash=${S["a"].state.video.currentVideo.infoHash}`),console.log("update player.Src",t),this.player.src([{src:t,type:"video/mp4"}])},updateProgress(t){if(t){let e=document.querySelector("#download-progress");if(!e){const t=document.querySelector(".vjs-progress-holder");if(!t)return;e=t.appendChild(document.createElement("div")),e.id="download-progress"}e.style.background=t.reduce(((t,e)=>t+`, ${e.color} 0%, ${e.color} ${e.length}, ${e.color} 0%`),"linear-gradient(90deg")+", transparent 0%)"}},async addSubtitle(t,e){var s;let a=t;if("string"===typeof t){if(t.startsWith("blob:"))return;a=t.startsWith("play://")?v(decodeURI(t.replace("play:///",""))):v(t)}e||(e=(null===(s=a)||void 0===s?void 0:s.name)||"");const i=e.match(/\.[^.]+$/)[0].toLowerCase();if(!i)return;console.log("addSubtitle() sub",a,e);let o=!1,n=!1;if(D)[".ass"].includes(i)?console.log("add .ass sub"):await Promise.all(c(a).map((t=>(o=!0,n=this.isRepeatSubtitle(t.label),console.log("obj",t,n),new Promise((s=>{setTimeout((()=>{n||this.player.addRemoteTextTrack({kind:"captions",label:t.label||e,src:t.src},!0),s()}))}))))));else{if(console.log("web addSubtitle()"),![".srt",".vtt"].includes(i))return;n=this.isRepeatSubtitle(e),n||await new Promise((t=>{const s=new FileReader;s.readAsText(a),s.onload=s=>{const a=".vtt"===i?s.target.result:f(s.target.result);this.player.addRemoteTextTrack({src:URL.createObjectURL(new Blob([a])),kind:"captions",label:e},!0),o=!0,t()}}))}if(n&&this.$q.notify(this.$t("the_added_subtitle_already_exists")),o){this.subsBtn.addClass("hidden");const t=this.player.textTracks();t&&t[0]&&(t[0].mode="showing"),this.appendAddSubBtn()}this.updateSubtitleList()},isRepeatSubtitle(t){const e=this.player.textTracks();let s=!1;for(let a=0;a<e.length;a++)t.includes(e[a].label)&&(s=!0);return s},updateSubtitleList(){const t=this.player.remoteTextTracks();this.subtitleList=[];for(let e=t.length-1;e>=0;e--)this.subtitleList.push(t[e].label);console.log("updateSubtitleList",this.subtitleList)},clearOldSubtitle(){this.subsBtn.removeClass("hidden");const t=this.player.remoteTextTracks();for(let e=t.length-1;e>=0;e--)this.player.removeRemoteTextTrack(t[e])},appendAddSubBtn(){const t=this;setTimeout((()=>{const e=this.player.controlBar.subsCapsButton,s=e.menu.children();if(!s)return;if(s.some((t=>"AddSubButton"===t.name_)))return;const a=e.menu.addChild("AddSubButton",{text:t.$t("add_subtitles")},2);a.addClass("add-sub-btn"),a.on("click",(()=>{this.$refs.subtitle.click()}))}),1e3)}}},K=G,X=(s("941d"),s("9989")),Y=Object(O["a"])(K,a,i,!1,null,null,null);e["default"]=Y.exports;A()(Y,"components",{QPage:X["a"]})},"941d":function(t,e,s){"use strict";s("52af")}}]);