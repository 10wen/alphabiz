const path=require("path"),{networkInterfaces:networkInterfaces}=require("os"),getPieceMap=e=>{if(!e.ready)return[];const r=e.pieces.length,t=r+128-r%128,o=t/128,a=[];let s=1,n=0;for(let c=0;c<t;c++)e.pieces[c]?s&=0:s&=1,n++,n>=o&&(a.push(s),s=1,n=0);return a};export const getByteMap=e=>{const r=getPieceMap(e),t=[];let o=0,a=0;for(let s=0;s<r.length;s++)a|=r[s]<<o,o++,o>=8&&(t.push(a),o=0,a=0);return t};const calcPieces=(e,r)=>{const t=e.pieceLength,o=e.length,a=Math.ceil(o/t),s=r.peerPieces;if(!s.buffer)return{progress:0,buffer:null};let n=0;for(const c of s.buffer){const e=c.toString(2).split("").filter((e=>"1"===e)).length;n+=e}return{progress:n/a,has:n,length:o}},responseTorrentProps=["infoHash","name","paused","length","downloaded","uploaded","ready","waiting","progress","isSeeding","upload","token","completed","origin","path","pending","file","magnetURI","isAutoUpload","isUploadByFiles","createdTime","completedTime","usedTime"],torrentToJson=(e,r,t)=>{const o={};responseTorrentProps.forEach((r=>{o[r]=e[r]})),o.done=e.downloaded>=e.length,o.download=1!==e.progress&&!e.upload,o.upload=e.upload,o.recieved=e.received,o.files=e.files?e.files.map((r=>({name:r.name,path:path.resolve(e.path,r.path),progress:r.progress>0?r.progress:0}))).filter((e=>!e.name.match(/^_____padding_file_(.*)____$/))):[],e.timeRemaining&&(o.timeRemaining=e.timeRemaining),e.metadata&&(o.hasMetadata=!0),e.numPeers&&(o.peersNum=e.numPeers);const a=getByteMap(e);return e.byteMap&&!a.some(((r,t)=>e.byteMap[t]!==r))||(e.byteMap=a,e.emit("byte-map-change")),o.byteMap=e.byteMap,e.trackerMap?o.trackerList=[...e.trackerMap.values()].map((e=>{const r={...e};return r.url.includes("@6")?r.isIpv6=!0:r.isIpv6=r.url.startsWith("ws")&&r.url.includes("ipv6"),r})).filter((({url:r,status:t})=>{if("error"!==t)return!0;let o=r;r.includes("@6")?o=r.replace("@6",""):o+="@6";const a=e.trackerMap.get(o);return!a||"error"===a.status})).sort(((e,r)=>e.url.localeCompare(r.url))):o.trackerList=[],o.connections=e.wires.map((o=>{let a="low";o._uploadThrottle._group===client.throttleGroups.mid&&(a="mid"),o._uploadThrottle._group===client.throttleGroups.high&&(a="high");let s=0,n=0;if(t.has(o._debugId)){const e=t.get(o._debugId);s=(o.downloaded-e.downloaded)/r,n=(o.uploaded-e.uploaded)/r}t.set(o._debugId,{downloaded:o.downloaded,uploaded:o.uploaded});let c=!1;e.byteMap&&o.remote_byte_map&&(c=e.byteMap.some(((e,r)=>{try{const t=e.toString(2).padStart(8,"0"),a=o.remote_byte_map[r].toString(2).padStart(8,"0");for(let e=0;e<t.length;e++)if("0"===t[e]&&"1"===a[e])return!0;return!1}catch(t){return!1}})));const{progress:d,buffer:i}=calcPieces(e,o);let p=o.remoteAddress;if(!p){const r=e._peers[o.peerId];if(r&&"webrtc"===r.type){const e=r.conn?._pc?.currentRemoteDescription?.sdp?.match(/c=IN\sIP\d\s(.*)/)?.[1];e&&(p=e)}}return{id:o.peerId,address:p,isAbPeer:o._is_alphabiz_peer_,hasMeta:o.remote_has_meta,hasResource:c,remoteByteMap:o.remote_byte_map||[],uploadSpeed:n,downloadSpeed:s,user:o.remoteUser,subId:o.remoteSub,transactions:o.transactions,remoteGroup:o.remoteGroup,downloaded:o.downloaded,level:a,progress:d,buffer:i}})),o.connections.sort(((e,r)=>e.address&&e.address.localeCompare?e.address.localeCompare(r.address):0)),o},getLocalIPList=()=>{const e=networkInterfaces(),r=new Set;for(const t in e){const o=e[t];o.forEach((e=>{r.add(e.address)}))}return[...r]},parseTrackerWarning=e=>"string"===typeof e&&e.includes("(")?e.substring(0,e.indexOf("(")).trim():e,addTracker=(e,r)=>{if(!e.discovery||!e.discovery.tracker)return;const t=e.discovery.tracker;if(!t._trackers.find((e=>e.announceUrl===r))&&t._createTracker)try{const e=[4];r.startsWith("http")&&e.push(6);for(const o of e){const e=t._createTracker(r,o);e&&(t._trackers.push(e),e.setInterval(),e.announce(t._defaultAnnounceOpts()))}}catch(o){console.error("addTracker error",o)}},removeTracker=(e,r,t)=>{if(!e.discovery||!e.discovery.tracker)return t();const o=e.discovery.tracker._trackers,a=o.findIndex((e=>e.announceUrl===r));if(-1===a)return t();const s=o[a];s&&s.destroy?s.destroy(((...e)=>{const a=o.findIndex((e=>e.announceUrl===r));-1!==a&&o.splice(a,1),"function"===typeof t&&t(...e)})):t()};export default{torrentToJson:torrentToJson,getLocalIPList:getLocalIPList,getPieceMap:getPieceMap,parseTrackerWarning:parseTrackerWarning,addTracker:addTracker,removeTracker:removeTracker};